\chapter{Картирование с прямой моделью в режиме реального времени}

\section{Картирование методом стохастического градиента}

Используя прямую модель Труна, мы предлагаем метод картирования, который использует преимущества прямой модели, при этом допускает реализацию, работающую в режиме реального времени. Как и раньше, через $m$ будем обозначать карту проходимости. Через $S$ - множество сонаров $s$. Через $o(m_i)$ будем обозначать занятость клетки $m_i$: $o(m_i) = 1$ - клетка проходима, $o(m_i) = 0$ - клетка непроходима. Введем следующий функционал от $m$ и $S$:

\begin{equation}\label{random:1}
  \Phi(m,S) = \phi_{sonars}(m,S) + \phi_{occupancy}(m) + \phi_{borders}(m),
\end{equation} 

Рассмотрим составляющие функционала \eqref{random:1}

\begin{enumerate}
  \item $\phi_{sonars}$ - распределение наблюдений сонаров $z_s$ при заданной карте проходимости $m$.   
  \begin{equation}\label{random:2}
    \phi_{sonars} = p(z_1,...,z_S|m) = \prod_{s \in S}{p(z_s|m)}
  \end{equation}

  \item $\phi_{occupancy}(m)$ отвечает за априорные представления о проходимости карты

  \begin{equation}\label{random:3}
    \phi_{occupancy}(m) = \sum_{m_i}{w_{o}o(m_i)}
  \end{equation}

  \item $\phi_{borders}(m)$ вводит штраф пропорциональный квадрату числа границ между проходимыми и непроходимы клетками 

  \begin{equation}\label{random:4}
    \phi_{borders}(m) = \sum_{m_i}{w_{b}n^2(m_i)}
  \end{equation}

\end{enumerate}

Весовые коэффициенты $w_o$ и $w_b$ позволяют регулировать значимость регуляризации и показаний сонаров.

Таким образом задача картирования сводится к задаче минимизации \eqref{random:1} по всем возможным картам проходимости

\begin{equation}\label{random:5}
  m^* = \argminl_{m} \phi_{sonars}(m,S) + \phi_{occupancy}(m) + \phi_{borders}(m)
\end{equation} 

Минимизация проводится стохастического градиента. На каждом шаге оптимизации выполняется следующее:

\begin{enumerate}
  \item Случайным образом выбирается клетка $m_i$ и значение проходимости $o(m_i)$ инвертируется.

  \item Для нового значения проходимости клетки $m_i$ пересчитываются  $\phi_{sonars}(m,S)$, $\phi_{occupancy}(m)$ и $\phi_{borders}(m)$.

  \item Если $\Phi_{new}(m,S)$ < $\Phi_{old}(m,S)$, то сохраняем новое значение $o(m_i)$, иначе инвертируем обратно. Для избежания застревания в локальных минимумах, инвертирование сохраняется с вероятностью $p_{rand}$, вне зависимости от $\Phi_{new}(m,S)$.
\end{enumerate}

При инвертировании одной клетки слагаемые $\phi_{occupancy}(m)$ и $\phi_{borders}(m)$ меняется очевидным образом (TODO описать???). 

В слагаемом $\phi_{sonars}(m,S) = \prod_{s \in S}{p(z_s|m)}$ меняются только те члены произведения, для которых инвертированная клетка лежит в области видимости сенсора.

Все это позволяет на каждом шаге быстро пересчитывать значение функционала $\Phi_{new}(m,S)$, так как приходится пересчитывать лишь малую часть функционала  $\phi_{sonars}(m,S)$, значения $\phi_{occupancy}(m)$ и $\phi_{borders}(m)$ зависит только от локальной части карты.