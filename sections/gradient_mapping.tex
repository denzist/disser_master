\chapter{Картирование методом градиентного спуска}

В этой главе предлагается другой метод построения карты проходимости. В отличии от других методов картирования с прямой моделью, в которых задача сводится к задаче оптимизации в конечномерных пространствах большой размерности, предлагаемый метод решает эту задачу в бесконечномерном пространстве. Для этого нужно переформулировать задачу картирования.


Представим клетки карты проходимости $m$ как переменные $x_i$, которые принимают значения от 0 до 1 - это значение характеризует степень занятости ячейки. Как и раньше будем искать такую карту $m^*$, которая наилучшим образом объясняет наблюдения сонаров, и для этого введем функцию, которая описывает, насколько хорошо карта $m$ объясняет измерения сонаров. В этом методе используется прямая модель сонара, отличная от модели Труна. Далее следует описание используемой модели.

\section{Модель сонара}

\subsection{Функция правдоподобия}


Измерение сонара $r$  несет в себе не только информацию о том, что на расстоянии $r$ скорее всего находится препятствие, но и о том, что на расстоянии меньше $r$ препятствия маловероятны. Поэтому каждое наблюдения сонара $r$ можно интерпретировать следующим образом: 
\begin{itemize}
  \item В некоторой области, расположенной на расстоянии примерно $r$ от сонара, располагается препятствие такого размера, чтобы сонар получил от него отражение на таком расстоянии.
  \item В области перед сонаром на расстоянии меньше $r$, препятствия определенных размеров, которые могли стать причиной показания сонара с меньшим $r$, отсутствуют.
\end{itemize}

Через $\Omega_{free}(m,z)$ будем обозначать множество переменных $x_i$, которые соответствуют клеткам карты, находящимся в области видимости сонара, где не должно быть препятствий в соответствии с наблюдением $z = (x,y,\phi,r)$. Множество переменных $x_i$,  которые соответствуют ячейкам карты, располагающимся в луче сонара там, где должно находиться препятствие, будем обозначать как $\Omega_{occ}(m,z)$.

В работе предполагается, что показание сонара определяется только суммарной (как будет показано ниже, взвешенной) площадью препятствий внутри областей $\Omega_{free}$ и $\Omega_{occ}$, и не зависит от взаимного расположения занятых клеток в них. Ясно, что на самом деле, на измерение сонара сильно влияет направление нормали к поверхности препятствия. Действительно, легче всего обнаружить то препятствие, поверхность которого перпендикулярна лучу сонара. Кроме того, сонары легче детектируют одно препятствие, расположенное в его поле зрения, чем несколько препятствий аналогичной формы и суммарной площади, которые рассредоточены в области луча. Данные эффекты в работе не рассматриваются.

Далее рассмотрим функцию правдоподобия $\psi(m,z)$, которая показывает, насколько хорошо карта $m$ объясняет показание сонара $z$. $\psi(m,z)$ состоит из двух слагаемых: $\psi_{free}(m,z)$ отвечает за отсутствие препятствий в области $\Omega_{free}(m,z)$, за наличие препятствий в области $\Omega_{occ}(m,z)$ -- $\psi_{occ}(m,z)$. Далее для наблюдения сонара $z_s$ и карты $m$ будем коротко записывать

\begin{equation}\label{gradient:1}
  \psi^s = \psi^s_{free} + \psi^s_{occ}
\end{equation}

Пусть $Z = \{z_1, ..., z_n\}$ - множество всех наблюдений сонаров. Тогда $\Psi(m,Z)$ - функция правдоподобия всех измерений сонаров. В этом алгоритме считается, что $\Psi(m,Z)$ является аддитивной относительно каждого наблюдения $z_s$, все показания датчиков имеют одинаковую достоверность и входят в $\Psi(m,Z)$ с равным весом. Поэтому значение функции правдоподобия $\psi^s$ должно принимать одинаковые максимальные и минимальные значения для различных сонаров. Постулируется, что для всех $s  \in \{1,..., n\}$ значения $\psi^s_{free}$ и $\psi^s_{occ}$ принимают значения от 0 до 1. Таким образом 

\begin{equation}\label{gradient:2}
  \Psi(m,Z) = \sum_{s \in Z} \psi^s_{free} + \psi^s_{occ} 
\end{equation}

Теперь рассмотрим, каким образом должно формироваться значение $\psi^s_{free}$ для области $\Omega^s_{free}$. Ясно, что занятые клетки внутри $\Omega^s_{free}$ противоречат наблюдению сонара. Однако, если чувствительность датчика низкая, то одна занятая ячейка не является достаточным основанием полагать, что показание сенсора не объяснено картой $m$. Таким образом внутри $\Omega^s_{free}$ может быть некоторое количество занятых клеток, которое зависит от чувствительности сонара. При этом не все ячейки в $\Omega_{free}$ являются равнозначными: состояние тех клеток, которые лежат ближе к сонару, должно вносить больший вклад в $\psi^s_{free}$, так как отражение импульса от них более вероятно, чем от более удаленных занятых клеток. Поэтому, чтобы получить оценку эффективного количества препятствий в $\Omega^s_{free}$, рассмотрим взвешенную сумму 

\begin{equation}\label{gradient:5}
  X = \sum_{x_i \in \Omega^s_{free}} x_i \omega_i
\end{equation}

где $\omega_i$ - вес, определяющий, насколько важной является ячейка $x_i$. Если взвешенная сумма $X$ меньше некоторого порогового значения $X_{free}$, то наблюдение $z_s$ считается хорошо объясненным. Если же сумма $X$ превышает $X_{free}$, то начисляется штраф, увеличивающийся с возрастанием $X$. Будем считать, что $\psi^s_{free}$ является кусочно линейной функцией вида 

\begin{equation}\label{gradient:4}
  \psi^s_{free} =
      \begin{cases}
      \alpha_{free} X, & X < X_{free} \\
      \alpha_{free} X_{free} + \beta_{free} (X - X_{free}), & X \ge X_{free} 
      \end{cases}
\end{equation}

Учитывая ограничение $\psi^s_{free}(1) = 1$, получаем  

\begin{equation}\label{gradient:5}
  \beta_{free} = \frac{1 - \alpha_{free} X_{free}}{1 - X_{free}}
\end{equation}

Параметр $\alpha_{free} > 0$ должен быть достаточно малым, но отличным от нуля. Это нужно для того, чтобы был ненулевой штраф при значениях $X \le X_{free}$, когда измерение сонара хорошо объяснено в области $\Omega^s_{free}$, и, таким образом, метод градиентного спуска мог бы сойтись.

Аналогичным образом, будем считать, что $\psi^s_{occ}$ является кусочно линейной функцией вида 

\begin{equation}\label{gradient:6}
  \psi^s_{occ} =
      \begin{cases}
      1 - \beta_{occ} X, & X < X_{occ} \\
      1 - \beta_{occ} X_{occ} - \alpha_{occ} (X - X_{occ}), & X \ge X_{occ} 
      \end{cases}
\end{equation}

при ограничении $\psi^s_{occ}(1) = 0$ и малом $\alpha_{occ} > 0$, откуда получается

\begin{equation}\label{gradient:7}
  \beta_{occ} = \frac{1 - \alpha_{occ} + \alpha_{occ} X_{occ}}{X_{occ}}
\end{equation}

\subsection{Вычисление весовых коэффициентов}

Далее через $X_{threshold}$ будем обозначать $X_{occ}$ и $X_{free}$. Для расчета порогов $X_{threshold}$ и весов $\omega_i$ необходимо знать чувствительность сонара. Обычно эта информация предоставляется в спецификации производителя, которая получается следующим образом: используется набор столбов различного диаметра, каждый из столбов помещается в разные точки области видимости сенсора. Таким образом для каждого из столбов определяется геометрическое место точек, в которых этот столб детектируется сонаром. Пример такой спецификации, использованный в данной работе, приведен в TODO\_specification. Можно обобщить это определение чувствительности сонара. \emph{Диаграммой чувствительности сонара} назовем функцию $d(x, y)$, определённую следующим образом: для каждой точки $(x, y)$ в системе координат сонара, $d(x, y)$ задает минимальный диаметр препятствия $d$, которое обнаруживается датчиком в этой точке. Для реального сонара диаграмма чувствительности $d(x,y)$ может быть построена эмпирически, либо приближенно на основе спецификации. В этой работе в качестве диаграммы чувствительности используется $s(x, y)$ - минимальная площадь препятствия, обнаруживаемая сонаром в точке $(x,y)$.

Теперь опишем, каким образом находятся веса $\omega_i$, при известной диаграмме чувствительности $d(x,y)$. Пусть площадь одной клетки равна $s$. Тогда для расчёта весов $\omega_i$ и порога $X_{threshold}$ можно использовать следующий алгоритм:
\begin{enumerate}
  \item Сначала происходит расчет предварительных весов: для каждой ячейки $x_i$ выбирается вес 
  
  \begin{equation}\label{gradient:8}
    \omega^0_i =  \min \Biggl( \frac{s}{s(x,y)},1 \Biggr)
  \end{equation}
  
  То есть вес равен отношению площади клетки к  минимальной  обнаруживаемой сонаром площади в этой точке, но если площадь ячейки больше, чем эта минимальная площадь, то вес берется равным 1. Тогда можно сказать, что сонар обнаружит препятствие, если $X = \sum_{x_i \in \Omega}{x_i \omega_i}$ будет не меньше 1.

  \item Чтобы значения функций $\psi_{free}$ и $\psi_{occ}$ были заключены между 0 и 1, необходимо чтобы $X$ принимала значения от 0 до 1. Для этого мы проводим нормировку

  \begin{equation}\label{gradient:9}
    \omega_i = \frac{\omega^0_i}{\sum{\omega^0_i}} 
  \end{equation}

  Тогда порог $X_{threshold}$ берётся равным

  \begin{equation}\label{gradient:10}
    X_{threshold} = \frac{1}{\sum{\omega^0_i}} 
  \end{equation}

\end{enumerate}

Теперь у нас есть все составляющие для того чтобы построить карту проходимости.

\section{Построение карты проходимости методом градиентного спуска}
