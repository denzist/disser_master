\chapter{Картирование методом градиентного спуска}
\label{chapter:gradient_mapping}

В этой главе предлагается другой метод построения карты проходимости. В отличии от других методов картирования с прямой моделью, в которых задача сводится к задаче оптимизации в конечномерных пространствах большой размерности, предлагаемый метод решает эту задачу в бесконечномерном пространстве. Для этого нужно переформулировать задачу картирования.


Представим клетки карты проходимости $m$ как переменные $x_i$, которые принимают значения от 0 до 1 - это значение характеризует степень занятости ячейки. Как и раньше будем искать такую карту $m^*$, которая наилучшим образом объясняет наблюдения сонаров, и для этого введем функцию, которая описывает, насколько хорошо карта $m$ объясняет измерения сонаров. В этом методе используется прямая модель сонара, отличная от модели Труна. Далее следует описание используемой модели.

\section{Модель сонара}

\subsection{Функция правдоподобия}


Измерение сонара $r$  несет в себе не только информацию о том, что на расстоянии $r$ скорее всего находится препятствие, но и о том, что на расстоянии меньше $r$ препятствия маловероятны. Поэтому каждое наблюдения сонара $r$ можно интерпретировать следующим образом: 
\begin{itemize}
  \item В некоторой области, расположенной на расстоянии примерно $r$ от сонара, располагается препятствие такого размера, чтобы сонар получил от него отражение на таком расстоянии.
  \item В области перед сонаром на расстоянии меньше $r$, препятствия определенных размеров, которые могли стать причиной показания сонара с меньшим $r$, отсутствуют.
\end{itemize}

Через $\Omega_{free}(m,z)$ будем обозначать множество переменных $x_i$, которые соответствуют клеткам карты, находящимся в области видимости сонара, где не должно быть препятствий в соответствии с наблюдением $z = (x,y,\phi,r)$. Множество переменных $x_i$,  которые соответствуют ячейкам карты, располагающимся в луче сонара там, где должно находиться препятствие, будем обозначать как $\Omega_{occ}(m,z)$.

В работе предполагается, что показание сонара определяется только суммарной (как будет показано ниже, взвешенной) площадью препятствий внутри областей $\Omega_{free}$ и $\Omega_{occ}$, и не зависит от взаимного расположения занятых клеток в них. Ясно, что на самом деле, на измерение сонара сильно влияет направление нормали к поверхности препятствия. Действительно, легче всего обнаружить то препятствие, поверхность которого перпендикулярна лучу сонара. Кроме того, сонары легче детектируют одно препятствие, расположенное в его поле зрения, чем несколько препятствий аналогичной формы и суммарной площади, которые рассредоточены в области луча. Данные эффекты в работе не рассматриваются.

Далее рассмотрим функцию правдоподобия $\psi(m,z)$, которая показывает, насколько хорошо карта $m$ объясняет показание сонара $z$. $\psi(m,z)$ состоит из двух слагаемых: $\psi_{free}(m,z)$ отвечает за отсутствие препятствий в области $\Omega_{free}(m,z)$, за наличие препятствий в области $\Omega_{occ}(m,z)$ -- $\psi_{occ}(m,z)$. Далее для наблюдения сонара $z_s$ и карты $m$ будем коротко записывать

\begin{equation}\label{gradient:1}
  \psi^s = \psi^s_{free} + \psi^s_{occ}
\end{equation}

Пусть $Z = \{z_1, ..., z_n\}$ - множество всех наблюдений сонаров. Тогда $\Psi(m,Z)$ - функция правдоподобия всех измерений сонаров. В этом алгоритме считается, что $\Psi(m,Z)$ является аддитивной относительно каждого наблюдения $z_s$, все показания датчиков имеют одинаковую достоверность и входят в $\Psi(m,Z)$ с равным весом. Поэтому значение функции правдоподобия $\psi^s$ должно принимать одинаковые максимальные и минимальные значения для различных сонаров. Постулируется, что для всех $s  \in \{1,..., n\}$ значения $\psi^s_{free}$ и $\psi^s_{occ}$ принимают значения от 0 до 1. Таким образом 

\begin{equation}\label{gradient:2}
  \Psi(m,Z) = \sum_{s \in Z} \psi^s_{free} + \psi^s_{occ} 
\end{equation}

Теперь рассмотрим, каким образом должно формироваться значение $\psi^s_{free}$ для области $\Omega^s_{free}$. Ясно, что занятые клетки внутри $\Omega^s_{free}$ противоречат наблюдению сонара. Однако, если чувствительность датчика низкая, то одна занятая ячейка не является достаточным основанием полагать, что показание сенсора не объяснено картой $m$. Таким образом внутри $\Omega^s_{free}$ может быть некоторое количество занятых клеток, которое зависит от чувствительности сонара. При этом не все ячейки в $\Omega_{free}$ являются равнозначными: состояние тех клеток, которые лежат ближе к сонару, должно вносить больший вклад в $\psi^s_{free}$, так как отражение импульса от них более вероятно, чем от более удаленных занятых клеток. Поэтому, чтобы получить оценку эффективного количества препятствий в $\Omega^s_{free}$, рассмотрим взвешенную сумму 

\begin{equation}\label{gradient:5}
  X = \sum_{x_i \in \Omega^s_{free}} x_i \omega_i
\end{equation}

где $\omega_i$ - вес, определяющий, насколько важной является ячейка $x_i$. Если взвешенная сумма $X$ меньше некоторого порогового значения $X^s_{free}$, то наблюдение $z_s$ считается хорошо объясненным. Если же сумма $X$ превышает $X^s_{free}$, то начисляется штраф, увеличивающийся с возрастанием $X$. Будем считать, что $\psi^s_{free}$ является кусочно линейной функцией вида 

\begin{equation}\label{gradient:4}
  \psi^s_{free} =
      \begin{cases}
      \alpha_{free} X, & X < X^s_{free} \\
      \alpha_{free} X^s_{free} + \beta_{free} (X - X^s_{free}), & X \ge X^s_{free} 
      \end{cases}
\end{equation}

Учитывая ограничение $\psi^s_{free}(1) = 1$, получаем  

\begin{equation}\label{gradient:5}
  \beta_{free} = \frac{1 - \alpha_{free} X^s_{free}}{1 - X^s_{free}}
\end{equation}

Параметр $\alpha_{free} > 0$ должен быть достаточно малым, но отличным от нуля. Это нужно для того, чтобы был ненулевой штраф при значениях $X \le X^s_{free}$, когда измерение сонара хорошо объяснено в области $\Omega^s_{free}$, и, таким образом, метод градиентного спуска мог бы сойтись.

Аналогичным образом, будем считать, что, при ограничении $\psi^s_{occ}(1) = 0$ и малом $\alpha_{occ} > 0$, $\psi^s_{occ}$ является кусочно линейной функцией вида

\begin{equation}\label{gradient:6}
  \psi^s_{occ} =
      \begin{cases}
      1 - \beta_{occ} X, & X < X^s_{occ} \\
      1 - \beta_{occ} X^s_{occ} - \alpha_{occ} (X - X^s_{occ}), & X \ge X^s_{occ} 
      \end{cases}
\end{equation}

\begin{equation}\label{gradient:7}
  \beta_{occ} = \frac{1 - \alpha_{occ} + \alpha_{occ} X^s_{occ}}{X^s_{occ}}
\end{equation}

\subsection{Вычисление весовых коэффициентов}

Далее через $X_{threshold}$ будем обозначать $X_{occ}$ и $X_{free}$. Для расчета порогов $X_{threshold}$ и весов $\omega_i$ необходимо знать чувствительность сонара. Обычно эта информация предоставляется в спецификации производителя, которая получается следующим образом: используется набор столбов различного диаметра, каждый из столбов помещается в разные точки области видимости сенсора. Таким образом для каждого из столбов определяется геометрическое место точек, в которых этот столб детектируется сонаром. Пример такой спецификации, использованный в данной работе, приведен в TODO\_specification. Можно обобщить это определение чувствительности сонара. \emph{Диаграммой чувствительности сонара} назовем функцию $d(x, y)$, определённую следующим образом: для каждой точки $(x, y)$ в системе координат сонара, $d(x, y)$ задает минимальный диаметр препятствия $d$, которое обнаруживается датчиком в этой точке. Для реального сонара диаграмма чувствительности $d(x,y)$ может быть построена эмпирически, либо приближенно на основе спецификации. В этой работе в качестве диаграммы чувствительности используется $s(x, y)$ - минимальная площадь препятствия, обнаруживаемая сонаром в точке $(x,y)$, построенная на основе TODO\_specification.

Теперь опишем, каким образом находятся веса $\omega_i$, при известной диаграмме чувствительности $d(x,y)$. Пусть площадь одной клетки равна $s$. Тогда для расчёта весов $\omega_i$ и порога $X_{threshold}$ можно использовать следующий алгоритм:
\begin{enumerate}
  \item Сначала происходит расчет предварительных весов: для каждой ячейки $x_i$ выбирается вес 
  
  \begin{equation}\label{gradient:8}
    \omega^0_i =  \min \Biggl( \frac{s}{s(x,y)},1 \Biggr)
  \end{equation}
  
  То есть вес равен отношению площади клетки к  минимальной  обнаруживаемой сонаром площади в этой точке, но если площадь ячейки больше, чем эта минимальная площадь, то вес берется равным 1. Тогда можно сказать, что сонар обнаружит препятствие, если $X = \sum_{x_i \in \Omega}{x_i \omega_i}$ будет не меньше 1.

  \item Чтобы значения функций $\psi_{free}$ и $\psi_{occ}$ были заключены между 0 и 1, необходимо чтобы $X$ принимала значения от 0 до 1. Для этого мы проводим нормировку

  \begin{equation}\label{gradient:9}
    \omega_i = \frac{\omega^0_i}{\sum{\omega^0_i}} 
  \end{equation}

  Тогда порог $X_{threshold}$ берётся равным

  \begin{equation}\label{gradient:10}
    X_{threshold} = \frac{1}{\sum{\omega^0_i}} 
  \end{equation}

\end{enumerate}
\label{gradient:calc_weights}

Теперь у нас есть все составляющие для того чтобы построить карту проходимости.


\begin{algorithm}[H]
  \caption{Алгоритм вычисления весов}
  \label{alg:weight_calc}
  \SetAlgoLined
  \KwData{$z_s$ -наблюдение, $s(x,y)$ и $s$ - диаграмма чувствительности и площадь одной клетки карты}
  \KwResult{$(\vv{\omega}^s_{free}, \vv{\omega}^s_{occ}, X^s_{free}, X^s_{occ})$, где $\vv{\omega}^s_{free}, \vv{\omega}^s_{occ}$ - вектора весов переменных $x_i$ в соответствии с наблюдением $z_s$, $X^s_{free}, X^s_{occ}$ - пороговые значения}
  \For{al $k \in \{free, occ\}$}
  {
    $\vv{\omega}^s_{free} = \vv{0}$\;
    $\vv{\omega}^s_{occ} = \vv{0}$\;

    \For{all $x_i$ in $\Omega^s_{k}$}
    {
      $\vv{\omega}^s_{k}[x_i] =  \min \Biggl( \frac{s}{s(x,y)},1 \Biggr)$\;
    }
    $S = \sum_{x_i}{\vv{\omega}^s_{k}[x_i]}$\;
    $X_{k} = \frac{1}{S}$\;
    \For{all $x_i$ in $\Omega^s_{k}$}
    {
      $\vv{\omega}^s_{k}[x_i] = \frac{\omega^0_i}{S}$\;
    }
  }
\end{algorithm}

\section{Построение карты проходимости методом градиентного спуска}

Для восстановления карты проходимости минимизируется $\Psi(m,Z)$, используя метод градиентного спуска. Обратим внимание, что все наши рассуждения о модели сонаров касались карт проходимости, в которых переменные $x_i$ принимают только значения 0 или 1. Оптимизация без ограничений может привести к значительным искажениям карты проходимости, когда $x_i$принимают значения больше 1 или меньше 0. Поэтому, вводятся дополнительные члены регуляризации в $\Psi(m,Z)$, ограничивающие значения переменных $x_i$ между 0 и 1. Похожий способ борьбы с артефактами может быть найден, например, в статье TODO\_Nikolaev.

Чтобы заключить значения проходимости клеток карты между 0 и 1 вводится следующая регуляризация ($c_1 > 0$)

\begin{equation}\label{gradient:11}
  R^i_{1}(x_i) = \begin{cases}
    c_1(x_i - 1), & x_i > 1 \\
    0, & x_i \in [0,1] \\
    -c_1 x_i, & x_i < 0 
    \end{cases}
\end{equation}

Ещё одно регуляризационное слагаемое, которое штрафует за близость значения переменной к 0.5, вводится для того, чтобы $x_i$ принимали значения ближе к 0 или 1 ($c_2 > 0$)

\begin{equation}\label{gradient:12}
  R^i_{2}(x_i) = \begin{cases}
    c_2 x_i, & x_i \in [0,0.5] \\
    c_2(1 - x_i), & x_i \in [0.5,1] \\
    0, & \text{иначе} 
    \end{cases} 
\end{equation}

Таким образом, получаем регуляризацию 

\begin{equation}\label{gradient:11}
  R^i(x_i) = R^i_1(x_i) + R^i_2(x_i)= \begin{cases}
    c_1(x_i - 1), & x_i > 1 \\
    c_2 x_i, & x_i \in [0,0.5] \\
    c_2(1 - x_i), & x_i \in [0.5,1] \\
    -c_1 x_i, & x_i < 0 
    \end{cases}
\end{equation}

Доопределим производные для всех $z_s$ и $x_i$

\begin{equation}\label{gradient:12}
  \begin{aligned}
    & \frac{\partial}{\partial x_i}\psi^s_{free}(X^s_{free}) = \frac{\partial}{\partial x_i} \psi^s_{occ}(X^s_{occ}) = 0 \\
    & \frac{\partial}{\partial x_i} R^i(0) = \frac{\partial}{\partial x_i} R^i(1) = \frac{\partial}{\partial x_i} R^i(0.5) = 0
  \end{aligned}
\end{equation}

Предположим что начальное приближение $m^0$ такое, что все $x_i = 0.5$, тогда из-за $\frac{\partial}{\partial x_i} R^i(0.5) = 0$, те клетки, которые не попали в область видимости ни одного сонара, соответствующие им $x_i$ останутся равны $0.5$.

Таким образом, задача построения оптимальной карты переходит в следующую задачу минимизации

\begin{equation}\label{gradient:13}
  m^*(Z) = \argminl_{m} \Biggl( \sum_{x_i}{R^i(x_i)} + \sum_{z_s \in Z}(\psi^s_{free} + \psi^s_{occ}) \Biggr)
\end{equation}

В работе предложенный алгоритм использовался только для обработки уже собранных данных. Скорость работы алгоритма позволяет использовать его в режиме реального времени, однако для работы в таком режиме (и для работы в течение неограниченного времени) необходимо осуществлять фильтрацию измерений, например, используя методы из \ref{section:real_time_tech}.