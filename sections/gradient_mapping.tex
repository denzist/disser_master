\chapter{Картирование методом градиентного спуска}
\label{chapter:gradient_mapping}

В этой главе предлагается другой подход к построению карты проходимости. В отличии от рассмотренных ранее методов на основе прямой модели, в которых картирование сводится к задаче оптимизации на конечномерных пространствах большой размерности, предлагаемый в этой главе метод решает задачу восстановления карты с помощью поиска минимума некоторого непрерывного штрафа. Чтобы прийти к этому методу нужно переформулировать задачу восстановления карты проходимости.

Представим клетки карты проходимости $m$ как переменные $x_i$, которые принимают значения от 0 до 1 и характеризуют степень занятости ячеек. Как и раньше будем искать такую карту $m^*$, которая наилучшим образом объясняет наблюдения сонаров, и для этого введем функцию, которая показывает, насколько хорошо карта $m$ объясняет наблюдения $Z$. В этом методе используется прямая модель сонара, отличная от модели \ref{thrun_model}. Далее следует описание используемой модели.

\section{Модель сонара}
\label{gradient_mapping:model}

\subsection{Функция правдоподобия}

Измерение сонара $r$  несёт в себе не только информацию о том, что на расстоянии $r$ скорее всего находится препятствие, но и о том, что на расстоянии меньше $r$ препятствия маловероятны. Поэтому каждое наблюдения сонара $r$ можно интерпретировать следующим образом:
\begin{itemize}
  \item В некоторой области, расположенной на расстоянии примерно $r$ от сонара, располагается препятствие такого размера, что датчик смог его детектировать на таком расстоянии.
  \item В области видимости сонара на расстоянии меньше $r$, препятствия определенных размеров, которые могли стать причиной измерения сонара с меньшим $r$, отсутствуют.
\end{itemize}

Через $\Omega_{free}(m,z)$ будем обозначать множество переменных $x_i$, которые соответствуют клеткам карты, находящимся внутри области видимости сонара, где не должно быть препятствий в соответствии с наблюдением $z = (x,y,\varphi,r)$. Множество переменных $x_i$,  которые соответствуют ячейкам карты, располагающимся в луче сонара там, где должно находиться препятствие, будем обозначать как $\Omega_{occ}(m,z)$.

В работе предполагается, что показание сонара определяется только суммарной (как будет показано ниже, взвешенной) площадью препятствий внутри областей $\Omega_{free}$ и $\Omega_{occ}$, и не зависит от взаимного расположения занятых клеток в них, несмотря на то, что на самом деле на измерение сонара сильно влияет направление нормали поверхности препятствия. Действительно, легче всего обнаружить то препятствие, поверхность которого перпендикулярна лучу сонара. Кроме того, сонары легче детектируют одно препятствие, расположенное в его поле зрения, чем несколько препятствий аналогичной формы и суммарной площади, которые рассредоточены в области луча. Данные эффекты в работе не рассматриваются.

Далее рассмотрим функцию правдоподобия $\psi(m,z)$, которая показывает, насколько хорошо карта $m$ объясняет показание сонара $z$. $\psi(m,z)$ состоит из двух слагаемых: $\psi_{free}(m,z)$ отвечает за отсутствие препятствий в области $\Omega_{free}(m,z)$, за наличие препятствий в области $\Omega_{occ}(m,z)$ -- $\psi_{occ}(m,z)$. Далее для наблюдения сонара $z_t$ и карты $m$ будем коротко записывать

\begin{equation}\label{gradient:1}
  \psi^t = \psi^t_{free} + \psi^t_{occ}
\end{equation}

Пусть $Z = \{z_1, ..., z_n\}$ - множество всех наблюдений сонаров. Тогда $\Psi(m,Z)$ - функция правдоподобия всех наблюдений сонаров. Будем считать, что $\Psi(m,Z)$ является аддитивной относительно каждого наблюдения $z_t$, все показания датчиков имеют одинаковую достоверность и входят в $\Psi(m,Z)$ с равным весом. Поэтому значение функции правдоподобия $\psi^t$ должно принимать одинаковые максимальные и минимальные значения для различных сонаров. Постулируется, что для всех $t  \in \{1,..., n\}$ значения $\psi^t_{free}$ и $\psi^t_{occ}$ принимают значения от 0 до 1. Таким образом

\begin{equation}\label{gradient:2}
  \Psi(m,Z) = \sum_{t: z_t \in Z} \psi^t_{free} + \psi^t_{occ}
\end{equation}

Теперь рассмотрим, каким образом должно формироваться значение $\psi^t_{free}$ для области $\Omega^t_{free}$. Ясно, что занятые клетки внутри $\Omega^t_{free}$ противоречат наблюдению сонара. Однако, если чувствительность датчика низкая, то одна занятая ячейка не является достаточным основанием полагать, что показание сенсора не объяснено картой $m$. Таким образом внутри $\Omega^t_{free}$ может быть некоторое количество занятых клеток, которое зависит от чувствительности сонара. При этом не все ячейки в $\Omega^t_{free}$ являются равнозначными: состояние тех клеток, которые лежат ближе к сонару, должно вносить больший вклад в $\psi^t_{free}$, так как отражение импульса от них более вероятно, чем от более удаленных занятых клеток. Поэтому, чтобы получить оценку эффективного количества препятствий в $\Omega^t_{free}$, рассмотрим взвешенную сумму

\begin{equation}\label{gradient:5}
  X = \sum_{x_i \in \Omega^t_{free}} x_i w_i
\end{equation}

где $w_i$ - вес, определяющий, насколько важной является ячейка $x_i$. Если взвешенная сумма $X$ меньше некоторого порогового значения $X^t_{free}$, то наблюдение $z_t$ считается хорошо объясненным. Если же сумма $X$ превышает $X^t_{free}$, то начисляется штраф, увеличивающийся с возрастанием $X$. Будем считать, что $\psi^t_{free}$ является кусочно линейной функцией вида

\begin{equation}\label{gradient:4}
  \psi^t_{free} =
      \begin{cases}
      \alpha_{free} X, & X < X^t_{free} \\
      \alpha_{free} X^t_{free} + \beta^t_{free} (X - X^t_{free}), & X \ge X^t_{free}
      \end{cases}
\end{equation}

Учитывая ограничение $\psi^t_{free}(1) = 1$, получаем

\begin{equation}\label{gradient:5}
  \beta^t_{free} = \frac{1 - \alpha_{free} X^t_{free}}{1 - X^t_{free}}
\end{equation}

Параметр $\alpha_{free} > 0$ должен быть достаточно малым, но отличным от нуля. Это нужно для того, чтобы был ненулевой штраф при значениях $X \le X^t_{free}$, когда измерение сонара хорошо объяснено в области $\Omega^t_{free}$, и, таким образом, метод градиентного спуска мог бы сойтись.

Аналогичным образом, будем считать, что, при ограничении $\psi^t_{occ}(1) = 0$ и малом $\alpha_{occ} > 0$, $\psi^t_{occ}$ является кусочно линейной функцией вида

\begin{equation}\label{gradient:6}
  \psi^t_{occ} =
      \begin{cases}
      1 - \beta^t_{occ} X, & X < X^t_{occ} \\
      1 - \beta^t_{occ} X^t_{occ} - \alpha_{occ} (X - X^t_{occ}), & X \ge X^t_{occ}
      \end{cases}
\end{equation}

\begin{equation}\label{gradient:7}
  \beta^t_{occ} = \frac{1 - \alpha_{occ} + \alpha_{occ} X^t_{occ}}{X^t_{occ}}
\end{equation}

\subsection{Весовые коэффициенты}

Далее через $X_{threshold}$ будем обозначать $X_{occ}$ и $X_{free}$. Для расчета порогов $X_{threshold}$ и весов $w_i$ необходимо знать информацию о чувствительности сонара. Обычно она предоставляется производителем и получается следующим образом: используется набор столбов различного диаметра, каждый из столбов помещается в разные точки диаграммы направленности датчика. Таким образом для каждого из столбов определяется геометрическое место точек, в которых он детектируется сонаром. Пример подобной спецификации приведен в \cite{specification}. В этой работе мы обобщаем данное представление чувствительности сонара.

\emph{Диаграммой чувствительности сонара} назовем функцию $s(x, y)$, определённую следующим образом: для каждой точки $(x, y)$ в системе координат сонара $s(x, y)$ задает минимальную площадь препятствия $s$, которое обнаруживается датчиком в этой точке. Для реального сонара диаграмма чувствительности $s(x,y)$ может быть построена эмпирически, либо приближенно на основе спецификации. В этой работе диаграмма чувствительности $s(x,y)$ была построена на основе \cite{specification}.

Теперь опишем, каким образом находятся веса $w_i$, при известной диаграмме чувствительности $s(x,y)$. Пусть площадь одной клетки равна $s$. Тогда для расчёта весов $w_i$ и порога $X_{threshold}$ можно использовать следующий алгоритм:
\begin{enumerate}
  \item Сначала происходит расчет предварительных весов: для каждой переменной $x_i$ выбирается вес

  \begin{equation}\label{gradient:8}
    w^0_i =  \min \Biggl( \frac{s}{s(x,y)},1 \Biggr)
  \end{equation}

  То есть вес равен отношению площади клетки $s$ к минимальной  обнаруживаемой сонаром площади $s(x,y)$в точке $(x,y)$, но всё же если площадь ячейки больше, чем эта минимальная площадь, то вес $w^0_i$ берется равным 1. Можно сказать, что сонар обнаружит препятствие в области $\Omega$, если $X = \sum_{x_i \in \Omega}{x_i w_i}$ будет не меньше 1.

  \item Чтобы значения функций $\psi_{free}$ и $\psi_{occ}$ были заключены между 0 и 1, необходимо чтобы $X$ принимала значения от 0 до 1. Для этого мы проводим нормировку

  \begin{equation}\label{gradient:9}
    w_i = \frac{w^0_i}{\sum_{i: x_i \in \Omega}{w^0_i}}
  \end{equation}

  Тогда порог $X_{threshold}$ берётся равным

  \begin{equation}\label{gradient:10}
    X_{threshold} = \frac{1}{\sum_{i: x_i \in \Omega}{w^0_i}}
  \end{equation}

\end{enumerate}
\label{gradient:calc_weights}

В алгоритме \ref{alg:weight_calc} приводится псевдокод функции вычисления весов.

\begin{algorithm}[H]
  \caption{Алгоритм вычисления весов}
  \label{alg:weight_calc}
  \SetAlgoLined
  \KwData{$z_t$ -наблюдение, $s(x,y)$ и $s$ - диаграмма чувствительности и площадь одной клетки карты}
  \KwResult{$(\vv{w}^t_{free}, \vv{w}^t_{occ}, X^t_{free}, X^t_{occ})$, где $\vv{w}^t_{free}, \vv{w}^t_{occ}$ - вектора весов переменных $x_i$ в соответствии с наблюдением $z_t$, $X^t_{free}, X^t_{occ}$ - пороговые значения}
  \For{al $k \in \{free, occ\}$}
  {
    $\vv{w}^t_{free} = \vv{0}$\;
    $\vv{w}^t_{occ} = \vv{0}$\;
    $S = 0$\;
    \For{all $x_i$ in $\Omega^t_{k}$}
    {
      $\vv{w}^t_{k}[x_i] =  \min \Biggl( \frac{s}{s(x,y)},1 \Biggr)$\;
      $S \mathrel{{+}{=}} \vv{w}^t_{k}[x_i]$\;
    }
    $X_{k} = \frac{1}{S}$\;
    \For{all $x_i$ in $\Omega^t_{k}$}
    {
      $\vv{w}^t_{k}[x_i] = \frac{\vv{w}^t_{k}[x_i]}{S}$\;
    }
  }
\end{algorithm}

Теперь у нас есть все составляющие алгоритма, восстанавливающего карту проходимости.


\section{Алгоритм картирования методом градиентного спуска}

Для восстановления карты проходимости минимизируется $\Psi(m,Z)$ \eqref{gradient:2}, используя метод градиентного спуска. Обратим внимание, что все наши рассуждения о модели сонаров касались карт проходимости, в которых переменные $x_i$ принимают только значения 0 или 1. Оптимизация без ограничений может привести к значительным искажениям карты проходимости, когда $x_i$ принимают значения больше 1 или меньше 0. Поэтому, вводятся дополнительные члены регуляризации в $\Psi(m,Z)$, ограничивающие значения переменных $x_i$ между 0 и 1. Похожий способ борьбы с артефактами может быть найден, например, в \cite{Shvets_2015}.

Чтобы заключить значения проходимости клеток карты между 0 и 1 вводится следующая регуляризация ($c_1 > 0$)

\begin{equation}\label{gradient:11}
  R^i_{1}(x_i) = \begin{cases}
    c_1(x_i - 1), & x_i > 1 \\
    0, & x_i \in [0,1] \\
    -c_1 x_i, & x_i < 0
    \end{cases}
\end{equation}

Ещё одно регуляризационное слагаемое, которое штрафует за близость значения переменной к 0.5, вводится для того, чтобы $x_i$ принимали значения ближе к 0 или 1 ($c_2 > 0$)

\begin{equation}\label{gradient:12}
  R^i_{2}(x_i) = \begin{cases}
    c_2 x_i, & x_i \in [0,0.5] \\
    c_2(1 - x_i), & x_i \in [0.5,1] \\
    0, & \text{иначе}
    \end{cases}
\end{equation}

Таким образом, получаем регуляризацию

\begin{equation}\label{gradient:11}
  R^i(x_i) = R^i_1(x_i) + R^i_2(x_i)= \begin{cases}
    c_1(x_i - 1), & x_i > 1 \\
    c_2 x_i, & x_i \in [0,0.5] \\
    c_2(1 - x_i), & x_i \in [0.5,1] \\
    -c_1 x_i, & x_i < 0
    \end{cases}
\end{equation}

Доопределим производные для всех $t$ и $x_i$

\begin{equation}\label{gradient:12}
  \begin{aligned}
    & \frac{\partial}{\partial x_i}\psi^t_{free}(X^t_{free}) = \frac{\partial}{\partial x_i} \psi^t_{occ}(X^t_{occ}) = 0 \\
    & \frac{\partial}{\partial x_i} R^i(0) = \frac{\partial}{\partial x_i} R^i(1) = \frac{\partial}{\partial x_i} R^i(0.5) = 0
  \end{aligned}
\end{equation}

Предположим что начальное приближение $m^0$ такое, что все $x_i = 0.5$, тогда из-за $\frac{\partial}{\partial x_i} R^i(0.5) = 0$, соответствующие $x_i$ тех клеток, которые не попали внутрь диаграммы направленности ни одного сонара, останутся равны $0.5$.

Таким образом, задача построения оптимальной карты переходит в следующую задачу минимизации

\begin{equation}\label{gradient:13}
  m^*(Z) = \argminl_{m} \Biggl( \sum_{x_i}{R^i(x_i)} + \sum_{t: z_t \in Z}(\psi^t_{free} + \psi^t_{occ}) \Biggr)
\end{equation}

В работе предложенный алгоритм использовался только для обработки уже собранных данных. Скорость работы алгоритма позволяет использовать его в режиме реального времени, однако для работы в таком режиме (и для работы в течение неограниченного времени) необходимо осуществлять фильтрацию измерений, например, используя подходы из \ref{section:real_time_tech}.