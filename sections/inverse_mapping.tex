\chapter{Обратная и прямая модель сонара. Методы восстановления карты проходимости.}

В этой главе описываются два подхода, используемых в большинстве известных на сегодняшний день алгоритмов для восстановления карты проходимости. Первый подход базируется на обратной модели сенсора. Основанный на этой модели алгоритм из \cite{Moravec_1988} будет рассмотрен подробно, так как построенные им карты проходимости будут использованы для сравнения с предложенными в следующих главах алгоритмами. Далее дается определение прямой модели и описывается суть методов картирования, основанных на ней. Предложенная в \cite{Thrun_2003} прямая модель описывается подробно, так как в дальнейшем она будет использована в главе \ref{random_mapping}.


\section{Обратная модель сенсора. Восстановление карты проходимости на основе обратной модели.}

\subsection{Обратная модель сенсора.}

Введем необходимые в дальнейшем обозначения. Пусть $m_i$ - клетка карты проходимости $m$. Будем считать, что каждая клетка $m_i$ - бинарная случайная величина, принимающая два значения: \{\emph{свободная, занятая}\}. \emph{Наблюдением} сенсора $z_t$ будем называть измерение и позу датчика в момент времени $t$, где это измерение было получено.

Величину $p(m_i|z_t)$ называют \emph{обратной моделью сенсора (inverse sensor model)}, выражающую вероятность занятости клетки $m_i$ при известном наблюдении $z_t$. По определению считается, что клетки карты являются независимыми случайными величинами. Эта модель называется обратной, так как она обратна процессу измерения -- расстояние до объекта в такой модели определяется показанием сонара, хотя в реальности наблюдение сонара определяется расстоянием до препятствия.

Из такого определения обратной модели следует, что совместное распределение $p(m_1,...,m_N|z) \equiv p(m|z)$ раскладывается следующим образом $p(m|z) = \prod_i{p(m_i|z)}$. Также заметим, что вероятность занятости клетки можно оценить только из наблюдения, независимо от состояния клеток-соседей.

Вместо того, чтобы напрямую решать задачу картирования, методы основанные обратной модели ищут оценивают следующую вероятность $p(m|z_1,...,z_T) \equiv p(m|z_{1,T})$, но проблема в том, что карта проходимости $m$ принадлежит пространству большой размерности. Однако используя обратную модель можно получить следующее:

\begin{equation}\label{inverse:0}
  p(m|z_{1,T}) = \prod_{i}{p(m_i|z_{1,T})}
\end{equation}

Таким образом задача сводится к оценке вероятностей занятости каждой клетки карты при известных наблюдениях.

\subsection{Описание стандартного метода картирования, основанного на обратной модели сенсора.}

Разложим $p(m_i|z_t)$ по правилу Байеса

\begin{equation}\label{inverse:1}
  p(m_i|z_{1,t}) = \frac{p(z_t|m_i, z_{1,t-1})p(m_i|z_{1,t-1})}{p(z_t|z_{1,t-1})}
\end{equation}

В предположении статичности окружения, ясно, что наблюдение $z_t$ не зависит от предыдущих наблюдений, при условии известной карты проходимости $m$

\begin{equation}\label{inverse:stat}
  p(z_t|m, z_{1,t-1}) = p(z_t|m)
\end{equation}

Выражение \eqref{inverse:stat} действительно верное при предположении о статичности окружения. Однако это утверждение усиливается, так как по определению обратной модели клетки считаются независимыми случайными величинами: наблюдение $z_t$ не зависит от предыдущих измерений при заданном состоянии клетки $m_i$, в независимости от состояний соседних клеток.

\begin{equation}\label{inverse:2}
  p(z_t|m_i, z_{1,t-1}) = p(z_t|m_i)
\end{equation}

Подставив \eqref{inverse:2} в \eqref{inverse:1}, снова воспользуемся правилом Байеса

\begin{equation}\label{inverse:3}
  p(m_i|z_{1,t}) = \frac{p(z_t|m_i)p(m_i|z_{1,t-1})}{p(z_t|z_{1,t-1})}
  = \frac{p(m_i| z_t) p(z_t) p(m_i|z_{1,t-1})}{p(m_i)p(z_t|z_{1,t-1})}
\end{equation}

Формула \eqref{inverse:3} выписана для оценки вероятности занятости клетки $m_i$. Аналогичное выражение можно получить для оценки вероятности того, что ячейка $m_i$ является свободной

\begin{equation}\label{inverse:4}
  p(\overline{m_i}|z_{1,t}) = \frac{p(\overline{m_i}| z_t) p(z_t) p(\overline{m_i}|z_{1,t-1})}{p(\overline{m_i})p(z_t|z_{1,t-1})}
\end{equation}

Поделив \eqref{inverse:3} на \eqref{inverse:4} получим

\begin{equation}\label{inverse:5}
  \frac{p(m_i|z_{1,t})}{p(\overline{m_i}|z_{1,t})} = \frac{p(m_i|z_t)}{p(\overline{m_i}| z_t)}
  \frac{p(\overline{m_i})}{p(m_i)}
  \frac{p(m_i|z_{1,t-1})}{p(\overline{m_i}|z_{1,t-1})}
\end{equation}

Заметим, что $p(\overline{m_i}) = 1 - p(m_i)$. Поэтому, переписав \eqref{inverse:5} в виде log-odds $l(m_i) = \log{\frac{p(m_i)}{1-p(m_i)}}$, окончательно получаем выражение итеративной оценки для $l(m_i|z_{1,t})$

\begin{equation}\label{inverse:6}
  l(m_i|z_{1,t}) = l(m_i|z_t) + l(m_i|z_{1,t-1}) - l(m_i)
\end{equation}

\begin{algorithm}[H]
  \caption{Картирование с обратной моделью сенсора}
  \label{alg:inverse_mapping}
  \SetAlgoLined
  \tcc{Инициализация}
  \For{all $m_i$ in $m$}
  {
    $l_i = \log{\frac{p(m_i)}{1 - p(m_i)}}$
  }

  \tcc{Рекурсивное обновление log-odds}

  \For{all $z_t$}
  {
    \For{all $m_i$ in $m$}
    {
      $l_i \mathrel{{+}{=}} \log{\frac{p(m_i|z_t)}{1 - p(m_i|z_t)}} - \log{\frac{p(m_i)}{1 - p(m_i)}}$
    }
  }

  \tcc{Получение вероятностей из log-odds}

  \For{all $m_i$ in $m$}
    {
      $p(m_i|z_{1,T}) = 1 - e^{-l_i}$
    }

\end{algorithm}


В \eqref{inverse:5} вероятность $p(m_i)$ выражает наши априорные представления о карте, обычно её полагают равной $0.5$, считая что какой-либо информации о занятости каждой клетки карты нам неизвестно ничего определенного.

\subsection{Недостатки стандартного метода картирования с обратной моделью.}

Выполнение предположения \eqref{inverse:2} является в некоторых случаях существенным, и его невыполнение влечет к артефактам на карте проходимости. Рассмотрим в качестве примера ситуацию, когда для картирования используется идеальные сонары (без ошибки измерений). Сонар имеет достаточно широкий луч (область видимости, диаграмма направленности), который часто представляется в виде конуса, пересекающий множество клеток (рисунок \ref{inv_mapping:sonars_example}). Измерение сонара говорит о следующем - на конце конуса должно находится препятствие, которое должно хорошо объяснять полученное измерение, при этом вероятность существования других препятствий внутри этого конуса невелико.

На рисунке \ref{inv_mapping:sonars_example} изображены два сонара (\emph{A, B}), области видимости которых пересекаются в нескольких клетках. Для сонара \emph{А} эти клетки принадлежат области препятствий, а для \emph{B} - свободной от препятствий территории. В результате работы алгоритма мы получим, противоречивую информацию о занятости этих клеток: одно измерение говорит о том, что эти ячейки должны быть заняты, другое - что свободны. В этом примере легко понять, что для того чтобы хорошо объяснить наблюдения сонаров \emph{A} и \emph{B}, клетки на пересечении конусов видимости должны быть свободны, так как есть другие клетки хорошо объясняющие эти измерения (Рис \ref{inv_mapping:sonars_example} (в)). Однако эта важная дополнительная информация не используется методом, в силу предположения о независимости клеток.

\begin{table}[h]
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_1.png} &
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_2.png} &
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_3.png}\\
    (а) & (б) & (в)\\
  \end{tabular}
    \caption{Сонары A и B, области видимости которых пересекаются в нескольких клетках (a). Карта проходимости для этого случая, которая будет построена алгоритмом с обратной моделью сонара (б).Верная карта проходимости для этого случая (в).}
    \label{inv_mapping:sonars_example}
\end{table}


На самом деле, эта проблема может коснуться не только традиционного метода, но и любой другой метод, который использует предположение о независимости клеток тогда, когда оно может не выполняться. Таким образом, можно сделать вывод о том, что использование данного метода может приводить к восстановлению такой карты проходимости, которая в некоторых случаях ошибочно объясняет наблюдения сонаров. В работе \cite{Thrun_2003} предложен другой подход к картированию, лишенный описанных в этой части проблем.
