\chapter{Картирование с прямой и обратной моделью сенсора}

В этой главе рассматриваются два ставших уже классическими подхода построения карт проходимости. TODO

\section{Картирование с обратной моделью сенсора}

Пусть $m_i$ - клетка карты проходимости $m$. Будем считать, что каждая клетка $m_i$ - бинарная случайная величина, принимающая два значения: \{свободная, занятая\}. \emph{Наблюдением} сенсора $z_t$ будем называть измерение и позу датчика в момент времени $t$, где это измерение было сделано. Вместо того, чтобы напрямую решать задачу картирования, будем искать вероятность занятости некоторой карты $m$ при наблюдениях $z_1,..., z_T$

$$p(m|z_1,...,z_T) \equiv p(m|z_{1,T})$$

Основная проблема в том, что карта проходимости $m$ принадлежит пространству большой размерности. Чтобы обойти эту проблему при оценке $p(m|z_{1,T})$, вводится предположение о том, что клетки карты $m_i$ - случайные, независимые величины. Тогда
$$p(m|z_{1,T}) = \prod_{i}{p(m_i|z_{1,T})}$$
Таким образом, достаточно понять, как можно оценить вероятность занятости клетки $i$ при известных наблюдениях $z_{1,T}$. Разложим $p(m_i|z_t)$ по правилу Байеса:

\begin{equation}\label{inverse:1}
  p(m_i|z_{1,t}) = \frac{p(z_t|m_i, z_{1,t-1})p(m_i|z_{1,t-1})}{p(z_t|z_{1,t-1})}
\end{equation}

В предположении статичности окружения, ясно, что наблюдение $z_t$ не зависит от предыдущих наблюдений, при условии заданной карты проходимости $m$:
  $$p(z_t|m, z_{1,t-1}) = p(z_t|m)$$
 
Это действительно верно в предположении о статичности окружения. Однако, в этом методе делается более сильное утверждение: \emph{наблюдение $z_t$ не зависит от предыдущих измерений при заданном состоянии клетки $m_i$, в независимости от состояний соседних клеток}.

\begin{equation}\label{inverse:2}
  p(z_t|m_i, z_{1,t-1}) = p(z_t|m_i) 
\end{equation}

Подставив в \eqref{inverse:1} формулу выше, снова воспользуемся правилом Байеса

\begin{equation}\label{inverse:3}
  p(m_i|z_{1,t}) = \frac{p(z_t|m_i)p(m_i|z_{1,t-1})}{p(z_t|z_{1,t-1})} 
  = \frac{p(m_i| z_t) p(z_t) p(m_i|z_{1,t-1})}{p(m_i)p(z_t|z_{1,t-1})}
\end{equation}

Напомним, что эта формула написана для случая, когда $m_i$ занята. Похожую формулу можно получить для свободной $m_i$:

\begin{equation}\label{inverse:4}
  p(\overline{m_i}|z_{1,t}) = \frac{p(\overline{m_i}| z_t) p(z_t) p(\overline{m_i}|z_{1,t-1})}{p(\overline{m_i})p(z_t|z_{1,t-1})}
\end{equation}

Поделив \eqref{inverse:3} на \eqref{inverse:4} получим

\begin{equation}\label{inverse:5}
  \frac{p(m_i|z_{1,t})}{p(\overline{m_i}|z_{1,t})} = \frac{p(m_i|z_t)}{p(\overline{m_i}| z_t)}
  \frac{p(\overline{m_i})}{p(m_i)}
  \frac{p(m_i|z_{1,t-1})}{p(\overline{m_i}|z_{1,t-1})}
\end{equation}

Заметим, что $p(\overline{m_i}) = 1 - p(m_i)$. Поэтому, переписав \eqref{inverse:5} в виде log-odds $l(p(m_i)) = \log{\frac{p(m_i)}{1-p(m_i)}}$, окончательно получаем формулу позволяющую рекурсивно вычислять $l(m_i|z_{1,t})$

\begin{equation}\label{inverse:6}
  l(m_i|z_{1,t}) = l(m_i|z_t) - l(m_i) + l(m_i|z_{1,t-1})
\end{equation}

% Первый алгоритм
\begin{algorithm}[H]
  \caption{Картирование с обратной моделью сенсора}
  \label{alg:inverse_mapping}
  \SetAlgoLined
  % \KwData{Входные данные}
  % \KwResult{Как прочитать книгу }
  \emph{Инициализация} 

  \For{all $m_i$ in $m$}
  {
    $l_i = \log{\frac{p(m_i)}{1 - p(m_i)}}$     
  %   \eIf{понятно}{
  %     перейти к следующей главе; текущей главой становится следующая глава;
  %   }{
  %   перейти к началу текущей главы;
  }

  \emph{Рекурсивное обновление log-odds}

  \For{all $z_t$}
  {
    \For{all $m_i$ in $m$}
    {
      $l_i += \log{\frac{p(m_i|z_t)}{1 - p(m_i|z_t)}} - \log{\frac{p(m_i)}{1 - p(m_i)}}$        
    }
  }

  \emph{Получение вероятностей из log-odds}

  \For{all $m_i$ in $m$}
    {
      $p(m_i|z_{1,T}) = 1 - e^{-l_i}$       
    }

\end{algorithm}


В \eqref{inverse:5} вероятность $p(m_i)$ выражает наши априорные представления о карте, обычно её полагают равной $0.5$, считая что какой-либо информации о занятости всей карты в целом нам ничего определенного неизвестно. 

\subsection{Обратная модель сенсора}

Величину $p(m_i|z_t)$ называют \emph{обратной моделью сенсора (inverse sensor model)}, выражающую вероятность занятости клетки $m_i$ при известном наблюдении $z_t$. Пример того как выглядит эта вероятность можно увидеть на рисунке  TODOInverseModelExample.

Заметим, что обратная модель \emph{напрямую не содержит в себе зависимость от соседних клеток}. Это очень важное допущение, которое предполагает, что о состоянии клетки можно сделать выводы основываясь только на \emph{наблюдениях}, независимо от соседних клеток карты. В этом заключается основной проблема этого метода, когда гипотеза о независимости клеток не работает.


\subsection{Недостатки метода картирования с обратной моделью}
Важное предположение о независимости клеток, необходимое для разложения вероятности $p(m)$ на произведение всех $p(m_i)$, является в некоторых случаях существенным. Рассмотрим в качестве примера ситуацию, когда для картирования используется идеальные сонары (без ошибки измерений). В отличие от лазерного дальномера, сонар имеет достаточно широкую область видимости, которая часто представляется в виде конуса, пересекающий множество клеток (см рис TODOInverseSonarsExample). Измерение сонара говорит о следующем - на конце конуса должно находится препятствие, которое должно хорошо объяснять полученное измерение.

На рисунке TODOInverseSonarsExample изображены два сонара, области видимости которых пересекаются в нескольких клетках. Для левого сонара эти клетки принадлежат области препятствия, а для правого - области свободной от препятствия. В результате работы алгоритма мы получим, противоречивую информацию о занятости этих клеток: одно измерение говорит о том, что эти клетки должны быть заняты, другое - что свободны. Легко понять, что эти клетки должны быть свободны, так как есть другие клетки хорошо объясняющие эти 2 измерения (Рис TODOInverseSonarsExample). Однако эта важная дополнительная информация не используется методом, в силу предположения о независимости клеток.

В случае идеальных лазерных дальномеров, у которых очень узкая область видимости, эта проблема практически не касается.

Таким образом, можно сделать вывод, что по крайней мере в случае сонаров, использовать этот метод с предположением о независимости клеток нельзя. Но напрямую вычислить вероятность $p(m|z_{1-t})$ не представляется возможным, так как пространство всевозможных карт огромно.

Себастьян Трун (Sebastian Thrun) в работе TODOThrun предложил другой метод картирования, лишенный проблем выше.



% Второй алгоритм
 
% \begin{algorithm}[H]
%   \SetAlgoLined %% Это соединяет линиями логические части
%   %% алгоритма типа if-then-else
  
%   \KwData{ experiment.data} %% здесь можно указать исходные параметры
%   \KwResult{ output, xoptimal } %% результат работы программы
%   x=0;
%   \While{ $\tau_{norm} > \varepsilon_{tol}$ }{
%     $s_{k-1} \leftarrow x_k - x_{k-1}$;
%     // Step lenght computation: %% это комментарий, который будет виден.
%     \eIf{$k$ is even}{
%       $ \alpha_k^{ABB} = \frac{ s_{k-1}^T y_{k-1}}{y_{k-1}^T y_{k-1}}$
%     }{ %% ELSE
%     $\alpha_k^{ABB} = \frac{ s_{k-1}^T s_{k-1}}{s_{k-1}^T y_{k-1}}$
%   } %% END eIf{$k$ is even}{
%   $k \leftarrow k + 1$;
%   \For{ i = 1}{
%     $x_{i+1} = P_\Omega(x_i - \alpha_k^{ABB}*g_k)$;
%   } %% END For{ i = 1}{
%   // Compute the termination constant %% это комментарий, который будет виден.
%   $\tau_{norm} = abs ( ||x_{k}||_2 - ||x_{k-1}||_2)$
% } %% END While{ $\tau_{norm} > \varepsilon_{tol}$ }{
% \caption{Pseudo-code for basic algorithm.}
% \label{alg:generalGP}
% \end{algorithm}