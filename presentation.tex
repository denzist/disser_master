\documentclass[10pt,pdf,hyperref={unicode}]{beamer}

%
% Choose how your presentation looks.
%
% For more themes, color themes and font themes, see:
% http://deic.uab.es/~iblanes/beamer_gallery/index_by_theme.html
%
\mode<presentation>
{
  \usetheme{default}      % or try Darmstadt, Madrid, Warsaw, ...
  \usecolortheme{default} % or try albatross, beaver, crane, ...
  \usefonttheme{default}  % or try serif, structurebold, ...
  \setbeamertemplate{navigation symbols}{}
  \setbeamertemplate{caption}[numbered]
}

\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{graphicx}
\usepackage{hyperref}
\graphicspath{{fig/}}

\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}
\newcommand*{\argminl}{\argmin\limits}
\newcommand*{\argmaxl}{\argmax\limits}


\title{Разработка и анализ методов восстановления карты проходимости на основе показаний датчиков измерения расстояния}
\author{Денис Шепелев}
\institute{студент группы 073а \\
ФУПМ МФТИ}

\date{}

\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\section{Задача восстановления карты проходимости}

\subsection{Карта проходимости}

\begin{frame}{Карта проходимости}
\begin{columns}
  \begin{column}{0.50\textwidth}
    \begin{itemize}
      \item
      {
        Карта проходимости - сетка, состоящая из квадратных клеток одинакового размера.
      }
      \item
      {
        Клетка карты - некоторая область пространства, содержащая информацию о наличии препятствия в соответствующей этой клетке территории.
      }
      \item
      {
        Такие карты используются в мобильной робототехнике для навигационных задач.
      }
    \end{itemize}
  \end{column}
  \begin{column}{0.50\textwidth}
    \begin{figure}[h]
      \centering
      \includegraphics[width=0.8\textwidth]{grid_map.png}
    \end{figure}
  \end{column}
\end{columns}
\end{frame}

\subsection{Датчики измерения расстояния}

\begin{frame}{Датчики измерения расстояния}

\begin{itemize}
  \item
  {
    Сонары
  }
  \item
  {
    \textcolor{red}{Лидары}
  }
  \item
  {
    \textcolor{red}{Стереокамеры}
  }
\end{itemize}

Сонары выбраны в качестве основного датчика, так как они значительно дешевле и доступнее лидаров, и могут использоваться при любом освещении, в отличии от стереопары.

\end{frame}


\subsection{Постановка задачи восстановления карты проходимости}

\begin{frame}{Постановка задачи восстановления карты проходимости}
\textbf{Дано}:
\begin{itemize}
  \item
  {
    Картируемое  окружение статично.
  }
  \item
  {
    Даны наблюдения датчиков:
    $$Z = \{z_1, ..., z_T\}$$
    $$z_t = (x_t, y_t , \varphi_t, r_t)$$

  }
\end{itemize}
\textbf{Цель}:
\begin{itemize}
  \item
  {
    Восстановить карту проходимости $m$ на основе наблюдений датчиков $Z$.
  }
\end{itemize}
\end{frame}

\section{Методы восстановления карты проходимости}

\subsection{Существующие методы картирования}

\begin{frame}{Существующие методы картирования}
На данный момент можно выделить два семейства методов восстановления карты проходимости
\begin{itemize}
  \item
  {
    основанные на обратной модели сенсора:

    \begin{equation}
      p(m|Z) = \prod_i{p(m_i|Z)}
    \end{equation}
  }
  \item
  {
    основанные на прямой модели сенсора:

    \begin{equation}
      p(Z|m)
    \end{equation}
  }
\end{itemize}

\end{frame}

\subsection{Традиционный метод картирования на основе обратной модели сенсора}

\begin{frame}{Традиционный метод картирования на основе обратной модели сенсора}

Допущения обратной модели:
\begin{itemize}
  \item
    Клетки карты $m_i$ - независимые случайные величины. Каждая ячейка карты $m$ хранит вероятность занятости $m_i$, с учётом наблюдений $Z$:
    \begin{equation}
      p(m|Z) = \prod_i{p(m_i|Z)}
    \end{equation}
  \item
    \begin{equation}
      p(z_t|m, z_{1,t-1}) = p(z_t|m)
    \end{equation}
\end{itemize}
Значения в клетках обновляются по формуле:
\begin{equation}
  \begin{split}
    \frac{p(m_i | z_{1:t}, x_{1:t})}{1 - p(m_i | z_{1:t}, x_{1:t})} =
    \frac{p(m_i | z_t, x_t)}{1- p(m_i | z_t, x_t)}
    \frac{p(m_i | z_{1..t-1}, x_{1:t-1})}{1- p(m_i | z_{1..t-1}, x_{1:t-1})}
    \frac{1 - p(m_i)}{p(m_{i})}
  \end{split}
\end{equation}

\end{frame}

\begin{frame}
Метод хотя и работает в режиме реального времени, однако когда допущения обратной модели невыполнены, карта проходимости, построенная с его помощью, может содержать грубые ошибки:

\begin{table}[h]
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_1.png} &
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_2.png} &
    \includegraphics[width=0.25\paperwidth]{two_sonars_example_3.png}
  \end{tabular}
\end{table}


\end{frame}

\subsection{Картирование на основе прямой модели сенсора}

\begin{frame}{Картирование на основе прямой модели сенсора}

\emph{Основная идея методов, основанных на прямой модели}:

\begin{itemize}
  \item Каждая клетка может принимать только два значения занятости: 1 - занятая, 0 - свободная.

  \item Прямая модель $p(Z|m)$ показывает, на сколько хорошо некоторая карта $m$ объясняет показания сонаров $Z$.

  \item Таким образом, задача картирования сводится к поиску такой карты $m^*$, которая максимизирует значение $p(Z|m)$:
    \begin{equation}
      m^*(Z) = \argmaxl_{m} p(Z|m)
    \end{equation}
\end{itemize}

Проблема большинства таких алгоритмов - невозможность имплементации для работы в режиме реального времени.
 % Требование работы в режиме реального времени к эффективному алгоритму построения карты проходимости является достаточно важным, так как часто такие модули являются неотъемлемой частью систем навигации робота.

\end{frame}

\begin{frame}
\begin{table}[h]
 \renewcommand\tablename{\figurename}
  \begin{tabular}{cc}
    \includegraphics[width=0.4\paperwidth]{thrun_inverse_result.png} &
    \includegraphics[width=0.4\paperwidth]{thrun_forward_result.png}
  \end{tabular}
    \caption{Результаты картирования двери, используя наблюдения сонаров. (а) - результаты алгоритма на основе обратной модели, (б) - на основе EM-алгоритма с прямой моделью, предложенной в работе Себастьяна Труна.}
\end{table}
\end{frame}

\section{Цель работы}

\subsection{Цель работы}

\begin{frame}{Цель работы}

Разработка методов восстановления карты проходимости, которые могут быть реализованы для работы в режиме реального времени, и картирующие лучше традиционного метода, основанного на обратной модели.

\end{frame}

\subsection{Предложенные в работе методы картирования}

\begin{frame}{Предложенные в работе методы картирования}
В данной работе предложены два новых метода построения карты проходимости:

\begin{itemize}
  \item первый основан на прямой модели сонара Труна, карта проходимости находится с помощью метода стохастического градиента;

  \item второй -- на новой прямой модели сонара, с помощью которой задачу картирования удалось свести к задаче минимизации непрерывной невязки.
\end{itemize}
\end{frame}

\section{Предложенные в работе методы картирования}

\subsection{Описание прямой модели Труна}

\begin{frame}{Описание прямой модели Труна}

Пусть внутри области видимости сонара находятся $K$ препятствий, отсортированных в порядке возрастания дистанции $d_k$. Через $\{ c_*, c_0, c_{1,K} \}$ будем обозначать множество различных сценариев работы сонара, через $c_*$ - случайный выброс, $c_0$ - измерение $R_{max}$.

\begin{enumerate}
  \item Пусть реализовался случай, когда измерение было порождено событием $c_k$, $k \in \{0,..,K\}$

  \begin{equation}\label{sonar_forward_model:1}
    p(z|m, c_k) = \frac{1}{\sqrt{2\pi \sigma^2}} e^{-\frac{1}{2}\frac{(z - d_k)^2}{\sigma^2}}
  \end{equation}

  \item Если реализовался случай  $c_*$, то

  \begin{equation}\label{sonar_forward_model:2}
    p(z|m, c_*) = \frac{1}{R_{max}}
  \end{equation}

\end{enumerate}

\end{frame}

\begin{frame}

Окончательная формула прямой модели:

\begin{equation}\label{sonar_forward_model:5}
\begin{split}
  p(z|m) &= \frac{1}{R_{max}} p_{rand}\\
   &+ \sum_{i \in \{1,...,K\}}{\frac{1}{\sqrt{2\pi \sigma^2}} e^{-\frac{1}{2}\frac{(z - d_k)^2}{\sigma^2}} (1 - p_{rand})(1 - p_{hit})^{k-1} p_{hit}}\\
   &+ \frac{1}{\sqrt{2\pi \sigma^2}} e^{-\frac{1}{2}\frac{(z - R_{max})^2}{\sigma^2}} (1 - p_{rand})(1 - p_{hit})^K
\end{split}
\end{equation}
\end{frame}

\subsection{Картирование методом стохастического градиента}

\begin{frame}{Картирование методом стохастического градиента}

Вводится следующая функция от $m$ при заданных наблюдениях $Z$:

\begin{equation}\label{random:1}
  \Phi(m,Z) = \phi_{sonars}(m,Z) + \phi_{occupancy}(m) + \phi_{borders}(m),
\end{equation}

  \begin{equation}\label{random:2}
    \phi_{sonars}(m,Z) = p(z_1,...,z_T|m) = \prod_{t}{p(z_t|m)}
  \end{equation}

  \begin{equation}\label{random:3}
    \phi_{occupancy}(m) = \sum_{m_i}{w_{o}o(m_i)}
  \end{equation}

  % При $w_o < 0$ карта $m$ штрафуется за каждую занятую клетку $m_i$.

  \begin{equation}\label{random:4}
    \phi_{borders}(m) = \sum_{m_i}{w_{b}n^2(m_i)}
  \end{equation}

  % где $n(m_i)$ - число таких соседей клетки $m_i$, состояние которых не совпадает с состоянием $m_i$. При $w_b < 0$ клетка штрафуется за каждого соседа, состояние которого не совпадает со состоянием клетки.

\end{frame}

\begin{frame}


Задача картирования сводится к поиску карты $m^*$, которая максимизирует \eqref{random:1}:

\begin{equation}\label{random:5}
  m^*(Z) = \argmaxl_{m} \Biggl(\phi_{sonars}(m,Z) + \phi_{occupancy}(m) + \phi_{borders}(m) \Biggr)
\end{equation}


\end{frame}

\begin{frame}


Оптимизационная задача \eqref{random:5} решается методом стохастического градиента. Каждый оптимизационный шаг состоит из следующих действий:

\begin{enumerate}
  \item Случайным образом выбирается клетка $m_i$ и значение проходимости $o(m_i)$ инвертируется
  $$o^*(m_i) = 1 - o(m_i)$$

  \item Для нового состояния клетки $m_i$ пересчитываются  $\phi_{sonars}(m,Z)$, $\phi_{occupancy}(m)$ и $\phi_{borders}(m)$.

  % В $\phi_{sonars}(m,Z) = \sum_{z_t}{\log p(z_t|m)}$ меняются только части суммы, для которых клетка $m_i$ лежит в области видимости сонара. Поэтому можно достаточно быстро пересчитать новое значение $\phi^*_{sonars}(m,Z)$. Также ясно, что при инвертировании одной клетки $m_i$ возможно быстро получить новые значения $\phi^*_{occupancy}(m)$ и $\phi^*_{borders}(m)$, так как $\phi_{occupancy}(m)$ и $\phi_{borders}(m)$ являются суммами функций от каждой клетки карты $m_k$, и их значения зависят только состояния клетки $m_k$ и её соседей.

  \item При $\Phi^*(m,Z) > \Phi(m,Z)$ или с вероятностью $p_{random factor}$ сохраняется $o^*(m_i)$ и $\Phi^*(m,Z)$, $\phi^*_{sonars}(m,Z)$, $\phi^*_{occupancy}(m)$, $\phi^*_{borders}(m)$; иначе возвращаемся в предыдущее состояние.

\end{enumerate}

\end{frame}

\subsection{Прямая модель для картирования методом градиентного спуска}

\begin{frame}{Прямая модель для картирования методом градиентного спуска}

Представим клетки карты проходимости $m$ как переменные $x_i$, которые принимают значения от 0 до 1 и характеризуют степень занятости ячеек.

Каждое наблюдение сонара порождает два множества клеток:
\begin{itemize}
  \item $\Omega_{free}(m,z)$ - суммарная занятость клеток внутри этого множества, должно быть не больше некоторого порога.

  \item $\Omega_{occ}(m,z)$ - суммарная занятость клеток внутри этого множества, должно быть не меньше некоторого порога.
\end{itemize}


\end{frame}

\begin{frame}

\begin{equation}\label{gradient:1}
  \psi = \psi_{free} + \psi_{occ}
\end{equation}

\begin{itemize}
  \item $\psi_{free} \equiv \psi_{free}(X_{free})$ - значение зависит от суммарной эффективной занятости $X_{free}$ внутри $\Omega_{free}$. Если $X_{free}$ больше некоторого порога, то значение штрафа достаточно велико, иначе - небольшое.

  \item $\psi_{occ} \equiv \psi_{occ}(X_{occ})$ - значение зависит от суммарной эффективной занятости $X_{occ}$ внутри $\Omega_{occ}$. Если $X_{occ}$ меньше некоторого порога, то значение штрафа достаточно велико, иначе - небольшое.

  \item Эффективная занятость множества клеток $\Omega$ считается следующим образом

  \begin{equation}\label{gradient:5}
    X_{\Omega} = \sum_{x_i \in \Omega} x_i w_i
  \end{equation}

\end{itemize}
\end{frame}

\begin{frame}

Функции штрафа - кусочно линейные функции вида:

\begin{equation}\label{gradient:4}
  \psi^t_{free} =
      \begin{cases}
      \alpha_{free} X, & X < X^t_{free} \\
      \alpha_{free} X^t_{free} + \beta^t_{free} (X - X^t_{free}), & X \ge X^t_{free}
      \end{cases}
\end{equation}

\begin{equation}\label{gradient:6}
  \psi^t_{occ} =
      \begin{cases}
      1 - \beta^t_{occ} X, & X < X^t_{occ} \\
      1 - \beta^t_{occ} X^t_{occ} - \alpha_{occ} (X - X^t_{occ}), & X \ge X^t_{occ}
      \end{cases}
\end{equation}
\end{frame}

\subsection{Картирование методом градиентного спуска}

\begin{frame}{Картирование методом градиентного спуска}

Для каждой клетки вводится кусочно линейная регуляризация $R^i(x_i)$:

\begin{equation}\label{gradient:11}
  R^i(x_i) =  \begin{cases}
    c_1(x_i - 1), & x_i > 1 \\
    c_2 x_i, & x_i \in [0,0.5] \\
    c_2(1 - x_i), & x_i \in [0.5,1] \\
    -c_1 x_i, & x_i < 0
    \end{cases}
\end{equation}

Таким образом, задача картирования сводится к минимизации непрерывного штрафа:

\begin{equation}\label{gradient:13}
  m^*(Z) = \argminl_{m} \Biggl( \sum_{x_i}{R^i(x_i)} + \sum_{t: z_t \in Z}(\psi^t_{free} + \psi^t_{occ}) \Biggr)
\end{equation}

\end{frame}

\subsection{Режим реального времени}

\begin{frame}{Режим реального времени}

Чтобы предложенные методы могли работать в режиме реального времени, нужно ограничить число наблюдений. Для этого  можно воспользоваться следующими способами:

\begin{itemize}
  \item Использовать скользящее окно и рассматривать последние $N_{max}$ наблюдений.

  \item В каждом узле трехмерной сетки $(x_i, y_i, \varphi_i)$ хранится список наблюдений $z_t = (x_t, y_t, \varphi_t, r_t)$, которые принадлежат соответствующей части пространства: $x_t \in [x_i - \Delta_x, x_i + \Delta_x]$,  $y_t \in [y_i - \Delta_y, y_i + \Delta_y]$ и $\varphi_t \in [\varphi_i - \Delta_{\varphi}, \varphi_i + \Delta_{\varphi}]$. Тогда в каждом узле можно хранить $N_{max}$ последних измерений или некоторым образом фильтрованные наблюдения. При этом масштаб этой сетки, может не совпадать с масштабом карты проходимости.
\end{itemize}

\end{frame}

\section{Результаты и заключене}

\subsection{Результаты картирования методом стохастического градиента}

\begin{frame}{Результаты картирования методом стохастического градиента}

\begin{table}[h]
 \centering
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \frame{\includegraphics[width=0.255\paperwidth]{env_doors.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{doors_inv_res_bin.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{doors_rand_res.png}}\\
    (а) & (б) & (в)
  \end{tabular}
  \caption{\label{results:randomized_inv_result} Результаты восстановления карты проходимости с помощью алгоритма картирования с обратной моделью (б) и методом стохастического градиента (в) на основе синтетических данных, собранных на территории (а).}
\end{table}

\end{frame}

\begin{frame}

\begin{table}[b]
 \centering
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \frame{\includegraphics[width=0.255\paperwidth]{env_real.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{real_inv_res_bin.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{real_rand_res.png}}\\
    (а) & (б) & (в)
  \end{tabular}
  \caption{\label{results:randomized_inv_real_result} Результаты восстановления карты проходимости с помощью алгоритма картирования с обратной моделью (б) и методом стохастического градиента (в) на основе реальных данных, собранных на территории (а).}
\end{table}


\end{frame}

\subsection{Результаты картирования методом градиентного спуска}

\begin{frame}{Результаты картирования методом градиентного спуска}

\begin{table}[h]
 \centering
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \frame{\includegraphics[width=0.255\paperwidth]{env_doors.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{doors_inv_res_bin.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{doors_grad_res_bin.png}}\\
    (а) & (б) & (в)
  \end{tabular}
  \caption{\label{results:gradient_inv_real_result} Результаты восстановления карты проходимости с помощью алгоритма картирования с обратной моделью (б) и методом градиентного спуска (в) на основе реальных данных, собранных на территории (а).}
\end{table}

\end{frame}

\begin{frame}

\begin{table}[b]
 \centering
 \renewcommand\tablename{\figurename}
  \begin{tabular}{ccc}
    \frame{\includegraphics[width=0.255\paperwidth]{env_real.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{real_inv_res_bin.png}} &
    \frame{\includegraphics[width=0.255\paperwidth]{real_grad_res_bin.png}}\\
    (а) & (б) & (в)
  \end{tabular}
  \caption{\label{results:gradient_inv_real_result} Результаты восстановления карты проходимости с помощью алгоритма картирования с обратной моделью (б) и методом градиентного спуска (в) на основе реальных данных, собранных на территории (а).}
\end{table}

\end{frame}

\subsection{Заключение}

\begin{frame}{Заключение}

\begin{itemize}
  \item В работы исследованы различные методы восстановления карты проходимости с помощью наблюдений сонаров. Оказалось, что традиционные методы восстанавливают карты с грубыми ошибками, а другие подходы невозможно использовать в режиме реального времени.

  \item В результате разработаны два новых метода картирования, предложена новая прямая модель сонара. Также предложен метод генерации данных сонаров, используя прямую модель.

  \item Предложенные методы картируют лучше традиционного метода и могут быть использованы в режиме реального времени.

\end{itemize}




\end{frame}

\end{document}
